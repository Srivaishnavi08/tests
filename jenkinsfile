pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'selenium/standalone-chrome'
        HTTP_SERVER_PORT = 8000
    }

    stages {
        stage('Pull Docker Image') {
            steps {
                script {
                    echo "Pulling Docker image: ${DOCKER_IMAGE}"
                    sh "docker pull ${DOCKER_IMAGE}"
                }
            }
        }
        
        stage('Start HTTP Server') {
            steps {
                script {
                    echo "Starting HTTP server on port ${HTTP_SERVER_PORT}"
                    // Start the local HTTP server
                    sh "python -m http.server ${HTTP_SERVER_PORT} &"
                    sleep 5 // Wait for the server to start
                }
            }
        }
        
        stage('Run Selenium WebDriver Container') {
            steps {
                script {
                    echo "Starting Selenium WebDriver container"
                    // Start the Selenium WebDriver container
                    sh "docker run -d --name selenium ${DOCKER_IMAGE} -v /dev/shm:/dev/shm -p 4444:4444"
                }
            }
        }
        
        stage('Run Selenium Test') {
            steps {
                script {
                    echo "Executing Selenium tests"
                    // Execute the Selenium test
                    sh 'python seleniumDockerTest.py'
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo "Stopping and removing Selenium container"
                    // Stop and remove the Selenium container
                    sh 'docker stop selenium || true' // Handle case if the container is already stopped
                    sh 'docker rm selenium || true' // Handle case if the container is already removed
                }
            }
        }
    }
    
    post {
        always {
            echo "Cleaning up the environment..."
            // Archive logs or reports if needed
            archiveArtifacts artifacts: '**/*.log', allowEmptyArchive: true
        }
    }
}
